<sl-button onclick="new_event_modal.show()">New Event</sl-button>

<sl-tree class="sortable" id="EventsList">
    <div class="htmx-indicator">Updating...</div>
    {% for event in events_list %}
    {% include 'new_event.html' %}
    {% endfor %}
</sl-tree>

<sl-dialog id="new_event_modal">
        <h1>New Event</h1>
        <h3>Bulk Upload with PDF</h3>
        <form
                hx-post="/events/pdf_scraper"
                hx-trigger="submit"
                hx-target="#EventBrowser"
                hx-swap="innerhtml"
                hx-encoding="multipart/form-data"
        >
            <label for="event_type">IJS/6.0: </label><br>
            <input type="text" id="event_type" name="event_type" autocomplete="off"/><br>
            <label for="pdf_file">Load PDF: </label><br>
            <input type="file" id="pdf_file" name="pdf_file_list" autocomplete="off" accept="application/pdf" required multiple/><br>
            <input type="hidden" name="competition_id" value={{ current_competition.id }}>

            <button type="submit" onclick="new_event_modal.hide()">
                By PDF!
            </button>
        </form>

        <sl-divider></sl-divider>

        <h3>Manual Single Event</h3>
        <form>
            <label for="event_number">Event Number: </label><br>
            <input type="text" id="event_number" name="event_number" autocomplete="off"/><br>
            <label for="event_name">Event Name: </label><br>
            <input type="text" id="event_name" name="event_name" autocomplete="off"/><br>
            <input type="hidden" name="competition_id" value={{ current_competition.id }}>

            <button
                    hx-post="/events/"
                    onclick="new_event_modal.hide()"
                    hx-target="#EventsList"
                    hx-swap="beforeend"
            >
                Submit
            </button>
        </form>
</sl-dialog>
    <script>
        console.log('sortable_loaded');

        // Function to initialize Sortable.js
        const initializeSortable = () => {
            const EventsList = document.querySelector('#EventsList');

            console.log(`EventsList: ${EventsList} loaded`);

            if (EventsList) {
                // Initialize Sortable.js
                Sortable.create(EventsList, {
                    animation: 150,
                    handle: 'sl-tree-item', // Handle for drag
                    draggable: 'sl-tree-item', // Draggable selector
                    onEnd: async (evt) => {
                        const itemId = evt.item.dataset.id; // Assuming each item has a `data-id` attribute
                        const oldIndex = evt.oldIndex;
                        const newIndex = evt.newIndex;

                        console.log(`Item ${itemId} moved from ${oldIndex} to ${newIndex}`);

                        try {
                            const response = await fetch('/events/update_position', {
                                method: 'PUT', // Use appropriate HTTP method
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    event_id: itemId,
                                    event_position: oldIndex,
                                    new_event_position: newIndex,
                                }),
                            });

                            if (!response.ok) {
                                console.error('Error updating position:', await response.text());
                            } else {
                                console.log('Position updated successfully');
                            }
                        } catch (error) {
                            console.error('Error hitting FastAPI endpoint:', error);
                        }
                    },
                });
            } else {
                console.error('Element with ID "EventsList" not found.');
            }
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeSortable();
        });

        // Reinitialize Sortable.js after HTMX content swap
        document.body.addEventListener('htmx:afterSwap', (event) => {
            console.log('HTMX swap detected, reinitializing Sortable.js');
            initializeSortable();
        });
    </script>