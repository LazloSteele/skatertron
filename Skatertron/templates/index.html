<!DOCTYPE html>
<html
        lang="en"
        class="sl-theme-dark"
>
    <head>
        <meta charset="UTF-8">
        <title>Skatertron</title>

        <!-- Hide custom elements until they are defined -->
        <style>
            :not(:defined) {
                visibility: hidden;
            }
        </style>

        <!-- initialize htmx, shoelace -->
        <script src="https://unpkg.com/htmx.org"></script>
        <script
                type="module"
                src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.15.1/cdn/shoelace-autoloader.js">
        </script>

        <!-- include the stylesheet and favicon -->
        <link
                href="{{ url_for('static', path='favicon.ico') }}"
                rel="shortcut icon"
                type="image/png"
        />
        <link
                rel="stylesheet"
                href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.19.1/cdn/themes/dark.css"
        />
        <!-- include sortable.js for list sorting -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
        <script src="static/js/file_picker.js"></script>

    </head>

    <body>

        <div class="AppFrame" id="AppFrame">
            <div class="CompetitionBrowser">
                <sl-button-group label="Competition Button Group">
                    <sl-select

                            placeholder="--Please Select Competition--"
                            id="Competition-Select"
                            hx-target="#EventBrowser"
                            hoist
                            clearable
                    >
                        {% for competition in competitions_list %}
                        {% include 'new_competition.html' %}
                        {% endfor %}
                    </sl-select>
                    <sl-button class="ModalButton" onclick="new_competition_modal.show()">New Competition</sl-button>
                </sl-button-group>

                <sl-dialog id="new_competition_modal">
                    <h1>New Competition</h1>
                    <form>
                        <label for="competition_name">Competition Name: </label><br>
                        <input type="text" id="competition_name" name="competition_name" autocomplete="off"/><br>
                        <label for="competition_year">Competition Year: </label><br>
                        <input type="number" id="competition_year" name="competition_year" min="2016" autocomplete="off"/><br>
                        <label for="host_club">Host Club: </label><br>
                        <input type="text" id="host_club" name="host_club" autocomplete="off"/><br>
                        <button
                                hx-post="/competitions/"
                                onclick="new_competition_modal.hide()"
                                hx-target="#Competition-Select"
                                hx-swap="beforeend"
                        >
                            Submit
                        </button>
                    </form>
                </sl-dialog>
            </div>
            <div class="EventBrowser" id="EventBrowser">
                Please Select a Competition
            </div>
        </div>
        <script src="{{ url_for('static', path='js/app.js') }}"></script>

        <!--
        <script>
            document.getElementById('EventBrowser').addEventListener('click', event => {
                if (event.target.matches('.add-file-btn')) {
                    const eventId = event.target.dataset.event;
                    const skateId = event.target.dataset.skate;

                    // Handle the file selection
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = 'video/*, image/*';
                    fileInput.onchange = async e => {
                        const file = e.target.files[0];
                        if (file) {
                            // TODO: add file api call
                            await populateFiles(file, eventId, skateId);
                        }
                    };
                    fileInput.click();
                }
            });
        </script>
        <script>
            async function populateFiles(videoFile, eventId, skateId) {
                const formData = new FormData();
                formData.append('file', videoFile.slice(0, 1024 * 100));
                formData.append('event_id', eventId);
                formData.append('skate_id', skateId);

                // Call API to get matching files
                const response = await fetch(`/skates/${skateId}/stage_file`, {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    const { videos, photos } = await response.json();

                    // Append videos and photos to the DOM
                    const skateElement = document.getElementById(`event-${eventId}-skate-${skateId}`);
                    const videoList = skateElement.querySelector('.video-list');
                    const photoList = skateElement.querySelector('.photo-list');

                    videos.forEach(video => {
                        const videoElement = document.createElement('div');
                        videoElement.textContent = video.name;
                        videoList.appendChild(videoElement);
                    });

                    photos.forEach(photo => {
                        const photoElement = document.createElement('div');
                        photoElement.textContent = photo.name;
                        photoList.appendChild(photoElement);
                    });
                } else {
                    console.error('Failed to populate files.');
                }
            }
        </script>
        -->
        <script>
            console.log('sortable_loaded');

            // Throttle timer variables to track the last HTMX swap
            let lastSwapTime = 0;
            const throttleDelay = 2000; // 2 seconds delay to limit reinitialization frequency

            // Function to initialize Sortable.js
            const initializeSortable = () => {
                const EventsList = document.querySelector('#EventsList');

                console.log(`EventsList: ${EventsList} loaded`);

                let sortableInitialized = false;
                let sortableInstance = null;

                if (EventsList) {

                    if (sortableInstance) {
                        sortableInstance.destroy();
                        console.log('Previous Sortable instance destroyed.');
                    }

                    // Initialize Sortable.js
                    Sortable.create(EventsList, {
                        animation: 150,
                        handle: 'sl-tree-item.event_branch', // Handle for drag
                        draggable: 'sl-tree-item.event_branch', // Draggable selector


                        onEnd: async (evt) => {
                            const allItems = EventsList.querySelectorAll('.event_branch');
                            let eventIdList = [];

                            allItems.forEach((item, index) => {
                                eventIdList.push(parseInt(item.dataset.id, 10));
                            });

                            try {
                                const response = await fetch('/events/update_position', {
                                    method: 'PUT', // Use appropriate HTTP method
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        event_id_list: eventIdList
                                    }),
                                });

                                if (!response.ok) {
                                    console.error('Error updating position:', await response.text());
                                } else {
                                    console.log('Position updated successfully');
                                }
                            } catch (error) {
                                console.error('Error hitting FastAPI endpoint:', error);
                            }
                        },
                    });
                    sortableInitialized = true;
                    console.log('Sortable.js initialized');
                } else {
                    console.error('Element with ID "EventsList" not found.');
                }
            };

            // Function to handle HTMX swap events, with delay
            const handleHTMXSwap = () => {
                const currentTime = Date.now();

                // If enough time has passed since the last initialization, initialize again
                if (currentTime - lastSwapTime >= throttleDelay) {
                    console.log('HTMX swap finished, initializing Sortable.js');
                    initializeSortable();
                    lastSwapTime = currentTime; // Update the last swap time
                }
            };

            document.body.addEventListener('htmx:afterSwap', handleHTMXSwap);
            document.body.addEventListener('sortable:end', initializeSortable);
        </script>
    </body>

</html>